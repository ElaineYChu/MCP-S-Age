---
title: "MCP-S-Age Report"
output: word_document
---

```{r setup, include=FALSE, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pander)
library(knitr)
```

**Case ID: `r input$caseid`**

**Analyst: `r input$analyst`**

Generated by MCP-S-Age v`r mcp_s_age_version()` on `r Sys.Date()`

https://kyra-stull.shinyapps.io/mcp-s-age/


----

```{r echo=FALSE, message=FALSE, warning=FALSE}
if (input$ci == 95) {
  ci <- analysis()$pred_df[which(analysis()$pred_df$Variable==input$plot_var),
                           "95%"]
} else {
  ci <- analysis()$pred_df[which(analysis()$pred_df$Variable==input$plot_var),
                           "99%"]
}

var <- analysis()[[input$plot_var]]$model_var
test_acc <- analysis()$pred_df[which(analysis()$pred_df$Variable==input$plot_var),"Test Accuracy"]
point <- round(analysis()[[input$plot_var]]$post$xmode, digits = 2)
```


## Results

- Mode trained on the following variable(s): **`r var`**
- Model testing accuracy: **`r test_acc`**
- Point Estimation: **`r point`** 
- `r paste0(input$ci,"%")` Credible Interval: **`r ci`**


```{r echo=FALSE, message=FALSE, warning=FALSE}
selected_model <- analysis()[[input$plot_var]]$post
      
      df <- data.frame(x=selected_model$x, y=selected_model$density)
      
      plot(df$x, df$y, type="l", lwd=2, col="#8d99ae",
           xlab="Age [years]", ylab="Posterior Density")
      abline(v=selected_model$xmode[1], lwd=2)
      if (input$ci == 95) {
        abline(v=selected_model$xlo[1], lwd=2, lty=2, col="#FF006E")
        abline(v=selected_model$xhi[1], lwd=2, lty=2, col="#FF006E")
      } else {
        abline(v=selected_model$xlolo[1], lwd=2, lty=2, col="#FFBE0B")
        abline(v=selected_model$xhihi[1], lwd=2, lty=2, col="#FFBE0B")
      }

      if (!is.na(input$xknown)) {
        abline(v=input$xknown, col="#8ac926", lwd=2)
      }
      
      if(is.na(input$xknown)) {
        if(input$ci == 95) {
          legend("topright",
                 c("Point Estimate", "95% Interval"),
                 col=c("black", "#FF006E"),
                 lty=c(1, 2),
                 lwd=c(2, 2))
        } else {
          legend("topright",
                 c("Point Estimate", "99% Interval"),
                 col=c("black", "#FFBE0B"),
                 lty=c(1, 2),
                 lwd=c(2, 2))
        }
        
      } else {
        if(input$ci == 95) {
          legend("topright",
                 c("Point Estimate", "95% Interval", "Known Age"),
                 col=c("black", "#FF006E", "#8ac926"),
                 lty=c(1, 2, 1),
                 lwd=c(2, 2, 2))
        } else {
          legend("topright",
                 c("Point Estimate", "99% Interval", "Known Age"),
                 col=c("black", "#FFBE0B", "#8ac926"),
                 lty=c(1, 2, 1),
                 lwd=c(2, 2, 2))
        }
      }
```


## Input

- Sample Population: **`r input$refsamp`**
- Known Age: **`r input$xknown`**
<!-- - Sample Sex: **`r input$sexsamp`** -->
<!-- - Age Prior: **`r input$ageprior`** -->

<br>

#### Input measurements

```{r echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
input_list <- data.frame(Variable = names(case_data()), Value = unname(unlist(case_data()[1,])))
pandoc.table(input_list, justify = 'centre')
```

\newpage

## Appendix: Results from all applicable age estimation models

`r kable(analysis()$pred_df, row.names=F)`
